<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 學生證製作器</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .page {
            display: none;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
        }

        .page.active {
            display: flex;
        }

        .btn-primary {
            background: #ff69b4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            margin: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        p {
            font-size: 1.1em;
            margin-bottom: 30px;
            color: white;
            opacity: 0.9;
        }

        .camera-container {
            position: relative;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        #camera {
            width: 100%;
            max-width: 300px;
            height: auto;
            display: block;
        }

        #preview {
            width: 100%;
            max-width: 300px;
            height: auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group.error input {
            border-color: #ff4757;
            animation: shake 0.5s ease-out;
        }

        .form-group.error label {
            color: #ff4757;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: white;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #ff69b4;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
        }

        .student-card-preview {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .final-card-container {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        #finalCard {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .controls {
            margin-top: 20px;
        }

        .action-buttons {
            margin-top: 30px;
        }

        .upload-option {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .processing-animation {
            margin: 40px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: #ff69b4;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-fill.animate {
            animation: progressFill 10s ease-out forwards;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ff69b4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .hidden {
            display: none !important;
        }

        .fade-enter {
            animation: fadeIn 0.3s ease-out;
        }

        .card-reveal {
            animation: cardReveal 1s ease-out forwards;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes progressFill {
            0% { width: 0%; }
            20% { width: 30%; }
            50% { width: 60%; }
            80% { width: 85%; }
            100% { width: 100%; }
        }

        @keyframes cardReveal {
            0% { 
                opacity: 0; 
                transform: scale(0.8) rotateY(90deg);
            }
            50% { 
                opacity: 0.5; 
                transform: scale(0.9) rotateY(45deg);
            }
            100% { 
                opacity: 1; 
                transform: scale(1) rotateY(0deg);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            h2 {
                font-size: 1.6em;
            }
            
            .btn-primary {
                padding: 12px 25px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- 載入畫面 -->
    <div id="loading" class="loading hidden">
        <div class="loading-spinner"></div>
        <p>處理中...</p>
    </div>

    <!-- 頁面 1: 首頁 -->
    <div id="page1" class="page active">
        <div class="container">
            <h1>AI 學生證製作器</h1>
            <p>搖身一變成為學生！</p>
            <button id="startBtn" class="btn-primary">開始製作</button>
        </div>
    </div>

    <!-- 頁面 2: 說明頁 -->
    <div id="page2" class="page">
        <div class="container">
            <h2>AI STUDENT ID CARD</h2>
            <p>輕鬆製作專屬學生證</p>
            <div class="student-card-preview">
                <div style="width: 200px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; margin: 0 auto; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">學生證預覽</div>
            </div>
            <button id="continueBtn" class="btn-primary">點我製作學生證</button>
        </div>
    </div>

    <!-- 頁面 3: 拍照頁 -->
    <div id="page3" class="page">
        <div class="container">
            <h2>拍攝大頭照</h2>
            
            <div class="camera-container">
                <video id="camera" autoplay playsinline></video>
                <canvas id="preview" style="display: none;"></canvas>
            </div>

            <div class="upload-option">
                <p>或選擇上傳照片</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <button id="uploadBtn" class="btn-secondary">選擇照片</button>
            </div>

            <div class="controls">
                <button id="captureBtn" class="btn-primary">拍照</button>
                <button id="retakeBtn" class="btn-secondary hidden">重拍</button>
                <button id="confirmPhotoBtn" class="btn-primary hidden">確認照片</button>
            </div>
        </div>
    </div>

    <!-- 頁面 4: 資料填寫頁 -->
    <div id="page4" class="page">
        <div class="container">
            <h2>輸入個人資料</h2>
            <form id="userForm">
                <div class="form-group">
                    <label for="userName">姓名：</label>
                    <input type="text" id="userName" required>
                </div>
                
                <div class="form-group">
                    <label>性別：</label>
                    <div class="radio-group">
                        <label><input type="radio" name="gender" value="male"> 男</label>
                        <label><input type="radio" name="gender" value="female"> 女</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="agreeTerms" required>
                        我同意使用條款
                    </label>
                </div>

                <button type="submit" class="btn-primary">完成註冊</button>
            </form>
        </div>
    </div>

    <!-- 頁面 5: 處理頁 -->
    <div id="page5" class="page">
        <div class="container">
            <h2>製作中...</h2>
            <div class="processing-animation">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <p>等待大約10秒，就好啦～</p>
            </div>
        </div>
    </div>

    <!-- 頁面 6: 完成頁 -->
    <div id="page6" class="page">
        <div class="container">
            <h2>你的專屬學生證</h2>
            <div class="final-card-container">
                <canvas id="finalCard"></canvas>
            </div>
            
            <div class="action-buttons">
                <button id="downloadBtn" class="btn-primary">下載儲存</button>
                <button id="shareBtn" class="btn-secondary">分享到社群</button>
            </div>
        </div>
    </div>

    <script>
        class StudentIDApp {
            constructor() {
                this.currentPage = 1;
                this.userData = {
                    name: '',
                    gender: '',
                    photo: null
                };
                this.cameraManager = new CameraManager();
                this.canvasManager = new CanvasManager();
                this.init();
            }

            init() {
                console.log('學生證製作器初始化...');
                this.bindEvents();
                this.showPage(1);
            }

            bindEvents() {
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.nextPage();
                });

                document.getElementById('continueBtn').addEventListener('click', () => {
                    this.nextPage();
                });

                document.getElementById('captureBtn').addEventListener('click', () => {
                    this.capturePhoto();
                });

                document.getElementById('retakeBtn').addEventListener('click', () => {
                    this.retakePhoto();
                });

                document.getElementById('confirmPhotoBtn').addEventListener('click', () => {
                    this.confirmPhoto();
                });

                document.getElementById('uploadBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileUpload(e);
                });

                document.getElementById('userForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitForm();
                });

                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadCard();
                });

                document.getElementById('shareBtn').addEventListener('click', () => {
                    this.shareCard();
                });
            }

            showPage(pageNumber) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                const targetPage = document.getElementById(`page${pageNumber}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                    targetPage.classList.add('fade-enter');
                    
                    setTimeout(() => {
                        targetPage.classList.remove('fade-enter');
                    }, 300);
                }

                this.currentPage = pageNumber;
                console.log(`切換到頁面 ${pageNumber}`);

                this.initPageSpecific(pageNumber);
            }

            nextPage() {
                if (this.currentPage < 6) {
                    this.showPage(this.currentPage + 1);
                }
            }

            initPageSpecific(pageNumber) {
                switch(pageNumber) {
                    case 3:
                        this.initCamera();
                        break;
                    case 5:
                        this.startProcessing();
                        break;
                }
            }

            async initCamera() {
                try {
                    await this.cameraManager.init();
                    console.log('相機初始化成功');
                } catch (error) {
                    console.error('相機初始化失敗:', error);
                    this.showError('無法啟動相機，請使用上傳功能');
                }
            }

            async capturePhoto() {
                try {
                    this.showLoading('拍照中...');
                    
                    const photoData = await this.cameraManager.capture();
                    this.userData.photo = photoData;
                    
                    this.hideLoading();
                    this.showCapturedPhoto();
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('拍照失敗:', error);
                    this.showError('拍照失敗，請重試');
                }
            }

            retakePhoto() {
                this.cameraManager.retake();
                this.hideCapturedPhoto();
            }

            confirmPhoto() {
                if (this.userData.photo) {
                    this.nextPage();
                } else {
                    this.showError('請先拍攝或上傳照片');
                }
            }

            showCapturedPhoto() {
                document.getElementById('captureBtn').classList.add('hidden');
                document.getElementById('retakeBtn').classList.remove('hidden');
                document.getElementById('confirmPhotoBtn').classList.remove('hidden');
            }

            hideCapturedPhoto() {
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('retakeBtn').classList.add('hidden');
                document.getElementById('confirmPhotoBtn').classList.add('hidden');
            }

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    this.showLoading('處理圖片中...');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.userData.photo = e.target.result;
                        this.hideLoading();
                        this.showCapturedPhoto();
                        
                        this.cameraManager.showPreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    this.showError('請選擇有效的圖片檔案');
                }
            }

            submitForm() {
                const form = document.getElementById('userForm');
                const formData = new FormData(form);
                
                if (!this.validateForm(formData)) {
                    return;
                }

                this.userData.name = document.getElementById('userName').value;
                this.userData.gender = formData.get('gender');

                console.log('用戶資料:', this.userData);
                this.nextPage();
            }

            validateForm(formData) {
                const name = document.getElementById('userName').value;
                const gender = formData.get('gender');
                const agreeTerms = document.getElementById('agreeTerms').checked;

                document.querySelectorAll('.form-group').forEach(group => {
                    group.classList.remove('error');
                });

                let isValid = true;

                if (!name || name.trim().length < 1) {
                    this.showFieldError('userName', '請輸入姓名');
                    isValid = false;
                }

                if (!gender) {
                    this.showError('請選擇性別');
                    isValid = false;
                }

                if (!agreeTerms) {
                    this.showError('請同意使用條款');
                    isValid = false;
                }

                return isValid;
            }

            showFieldError(fieldName, message) {
                const field = document.getElementById(fieldName);
                if (field) {
                    const formGroup = field.closest('.form-group');
                    if (formGroup) {
                        formGroup.classList.add('error');
                    }
                }
                this.showError(message);
            }

            startProcessing() {
                const progressBar = document.querySelector('.progress-fill');
                if (progressBar) {
                    progressBar.classList.add('animate');
                }

                setTimeout(() => {
                    this.generateStudentCard();
                }, 10000);
            }

            async generateStudentCard() {
                try {
                    this.showLoading('生成學生證中...');
                    
                    const cardCanvas = await this.canvasManager.generateCard(this.userData);
                    
                    const finalCard = document.getElementById('finalCard');
                    const ctx = finalCard.getContext('2d');
                    finalCard.width = cardCanvas.width;
                    finalCard.height = cardCanvas.height;
                    ctx.drawImage(cardCanvas, 0, 0);
                    
                    this.hideLoading();
                    this.nextPage();
                    
                    setTimeout(() => {
                        finalCard.classList.add('card-reveal');
                    }, 100);
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('生成學生證失敗:', error);
                    this.showError('生成學生證失敗，請重試');
                }
            }

            downloadCard() {
                try {
                    const canvas = document.getElementById('finalCard');
                    if (!canvas) {
                        this.showError('找不到學生證圖片');
                        return;
                    }

                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${this.userData.name || 'student'}_id_card.png`;
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        URL.revokeObjectURL(url);
                        this.showSuccess('學生證已下載！');
                    }, 'image/png', 0.9);
                    
                } catch (error) {
                    console.error('下載失敗:', error);
                    this.showError('下載失敗，請重試');
                }
            }

            shareCard() {
                this.showSuccess('請使用下載功能儲存圖片後手動分享');
            }

            showLoading(message = '處理中...') {
                const loading = document.getElementById('loading');
                const loadingText = loading.querySelector('p');
                if (loadingText) {
                    loadingText.textContent = message;
                }
                loading.classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }

            showError(message) {
                alert(`錯誤：${message}`);
            }

            showSuccess(message) {
                alert(`成功：${message}`);
            }
        }

        class CameraManager {
            constructor() {
                this.stream = null;
                this.video = null;
                this.canvas = null;
                this.context = null;
                this.currentPhoto = null;
            }

            async init() {
                try {
                    this.video = document.getElementById('camera');
                    this.canvas = document.getElementById('preview');
                    this.context = this.canvas.getContext('2d');

                    const constraints = {
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        },
                        audio: false
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;

                    return new Promise((resolve, reject) => {
                        this.video.onloadedmetadata = () => {
                            this.video.play();
                            console.log('相機啟動成功');
                            resolve();
                        };
                        
                        this.video.onerror = (error) => {
                            console.error('視頻載入失敗:', error);
                            reject(error);
                        };
                    });

                } catch (error) {
                    console.error('相機初始化失敗:', error);
                    throw new Error('無法啟動相機，請檢查瀏覽器權限');
                }
            }

            async capture() {
                try {
                    if (!this.video || !this.canvas) {
                        throw new Error('相機未初始化');
                    }

                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;
                    this.context.drawImage(this.video, 0, 0);

                    const photoData = this.canvas.toDataURL('image/png', 0.9);
                    this.currentPhoto = photoData;

                    this.showPreview(photoData);

                    console.log('拍照成功');
                    return photoData;

                } catch (error) {
                    console.error('拍照失敗:', error);
                    throw error;
                }
            }

            showPreview(photoData) {
                this.video.style.display = 'none';
                this.canvas.style.display = 'block';

                if (photoData) {
                    const img = new Image();
                    img.onload = () => {
                        this.canvas.width = img.width;
                        this.canvas.height = img.height;
                        this.context.drawImage(img, 0, 0);
                    };
                    img.src = photoData;
                }
            }

            retake() {
                this.video.style.display = 'block';
                this.canvas.style.display = 'none';
                this.currentPhoto = null;
            }
        }

        class CanvasManager {
            async generateCard(userData) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const cardWidth = 600;
                const cardHeight = 400;
                canvas.width = cardWidth;
                canvas.height = cardHeight;

                this.drawSimpleTemplate(ctx, cardWidth, cardHeight);

                if (userData.photo) {
                    const userPhoto = await this.loadUserPhoto(userData.photo);
                    this.drawUserPhoto(ctx, userPhoto);
                }
                
                this.drawUserInfo(ctx, userData, cardWidth, cardHeight);
                this.drawDecorations(ctx, cardWidth, cardHeight);

                return canvas;
            }

            drawSimpleTemplate(ctx, width, height) {
                const gradient = ctx.createLinearGradient(0, 0, width, height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);

                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                this.roundRect(ctx, 20, 20, width - 40, height - 40, 15);
                ctx.fill();

                ctx.fillStyle = '#333';
                ctx.font = 'bold 28px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('STUDENT ID CARD', width / 2, 70);

                ctx.font = 'bold 16px Arial, sans-serif';
                ctx.fillText('2024', width / 2, 95);

                ctx.fillStyle = '#ff69b4';
                ctx.fillRect(40, 100, width - 80, 3);
            }

            drawUserPhoto(ctx, userPhoto) {
                const photoX = 50;
                const photoY = 120;
                const photoWidth = 120;
                const photoHeight = 150;

                ctx.save();
                ctx.beginPath();
                this.roundRect(ctx, photoX, photoY, photoWidth, photoHeight, 8);
                ctx.clip();

                const scale = Math.max(photoWidth / userPhoto.width, photoHeight / userPhoto.height);
                const scaledWidth = userPhoto.width * scale;
                const scaledHeight = userPhoto.height * scale;

                const offsetX = photoX + (photoWidth - scaledWidth) / 2;
                const offsetY = photoY + (photoHeight - scaledHeight) / 2;

                ctx.drawImage(userPhoto, offsetX, offsetY, scaledWidth, scaledHeight);
                ctx.restore();

                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 2;
                ctx.beginPath();
                this.roundRect(ctx, photoX, photoY, photoWidth, photoHeight, 8);
                ctx.stroke();
            }

            drawUserInfo(ctx, userData, cardWidth, cardHeight) {
                const textX = 200;
                let textY = 150;

                ctx.fillStyle = '#333';
                ctx.textAlign = 'left';

                ctx.font = 'bold 24px Arial, sans-serif';
                ctx.fillText('姓名:', textX, textY);
                ctx.font = '22px Arial, sans-serif';
                ctx.fillText(userData.name || '未填寫', textX + 70, textY);
                textY += 40;

                ctx.font = 'bold 20px Arial, sans-serif';
                ctx.fillText('性別:', textX, textY);
                ctx.font = '18px Arial, sans-serif';
                const genderText = userData.gender === 'male' ? '男' : 
                                  userData.gender === 'female' ? '女' : '未填寫';
                ctx.fillText(genderText, textX + 70, textY);
                textY += 40;

                const studentId = this.generateStudentId();
                ctx.font = 'bold 20px Arial, sans-serif';
                ctx.fillText('學號:', textX, textY);
                ctx.font = '18px Arial, sans-serif';
                ctx.fillText(studentId, textX + 70, textY);
                textY += 40;

                ctx.font = 'bold 20px Arial, sans-serif';
                ctx.fillText('科系:', textX, textY);
                ctx.font = '18px Arial, sans-serif';
                ctx.fillText('AI設計學系
